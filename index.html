<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UkeFlow üå∫ - Tu Entrenador de Ukulele</title>
    <style>
        :root {
            --primary: #FF6B6B;
            /* Corail */
            --secondary: #4ECDC4;
            /* Turquoise */
            --accent: #FFE66D;
            /* Yellow */
            --dark: #2C3E50;
            --light: #F7F9FC;
            --card-bg: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* MAIN CONTENT */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* CARD STYLES */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* SEARCH / SELECT */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            width: 100%;
        }

        select {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #eee;
            font-size: 1rem;
        }

        /* CHORD DISPLAY (BIG) */
        #active-chord-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 250px;
        }

        .chord-name {
            font-size: 4rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        canvas.chord-diagram {
            border: none;
        }

        /* TELEPROMPTER AREA */
        #teleprompter {
            height: 120px;
            overflow: hidden;
            position: relative;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #eee;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .prompter-line {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            width: 100%;
            position: absolute;
            left: 0;
            text-align: center;
        }

        .prompter-line.past {
            color: #ccc;
            transform: translateY(-30px) scale(0.9);
            opacity: 0.5;
        }

        .prompter-line.current {
            color: var(--dark);
            font-weight: bold;
            transform: translateY(30px) scale(1.1);
        }

        .prompter-line.future {
            color: #999;
            transform: translateY(90px) scale(0.9);
            opacity: 0.5;
        }

        .chord-badge {
            background: var(--secondary);
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            margin-right: 8px;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* CONTROLS */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: filter 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:hover {
            filter: brightness(1.1);
        }

        button:active {
            transform: scale(0.98);
        }

        button.secondary {
            background: #95a5a6;
        }

        button.accent {
            background: var(--accent);
            color: var(--dark);
        }

        .slider-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        input[type=range] {
            flex: 1;
        }

        .progress-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            width: 100%;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.2s linear;
        }

        /* FOOTER INFO */
        .status-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
        }

        @media (max-width: 400px) {
            .chord-name {
                font-size: 3rem;
            }

            #active-chord-display {
                height: 200px;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>üé∏ UkeFlow</h1>
    </header>

    <main>
        <div class="search-container">
            <select id="song-select">
                <option value="" disabled selected>Elige una canci√≥n...</option>
                <!-- Generated via JS -->
            </select>
        </div>

        <div class="card" id="stage">
            <div id="active-chord-display">
                <div class="chord-name" id="current-chord-name">-</div>
                <canvas id="chord-canvas" width="120" height="140"></canvas>
            </div>

            <div id="teleprompter">
                <div class="prompter-line past" id="line-prev">...</div>
                <div class="prompter-line current" id="line-curr">¬°Listo para tocar!</div>
                <div class="prompter-line future" id="line-next">Dale Play ‚ñ∂</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="status-info">
                <span id="time-display">0:00 / 0:00</span>
                <span id="bar-display">Comp√°s: 1</span>
            </div>
        </div>

        <div class="card controls">
            <button id="btn-play" class="accent">‚ñ∂ Play</button>
            <button id="btn-reset" class="secondary">‚èÆ Reinicio</button>

            <div class="slider-control">
                <span>üê¢</span>
                <input type="range" id="speed-slider" min="0.5" max="1.5" step="0.1" value="1.0">
                <span>üêá</span>
                <span id="speed-val">100%</span>
            </div>

            <div class="slider-control" style="justify-content: center;">
                <button class="secondary" id="btn-transpose-down" style="padding: 5px 15px;">b</button>
                <span id="transpose-val" style="width: 30px; text-align: center;">0</span>
                <button class="secondary" id="btn-transpose-up" style="padding: 5px 15px;">#</button>
            </div>
        </div>
    </main>

    <script>
        /**
         * DATABASE & LOGIC
         */

        // 1. CHORD DATABASE (Standard G-C-E-A tuning)
        // Format: [G, C, E, A] strings. 0 = open, -1 = muted (uncommon in uke)
        const CHORD_LIBRARY = {
            'C': [0, 0, 0, 3], 'Cm': [0, 3, 3, 3], 'C7': [0, 0, 0, 1],
            'D': [2, 2, 2, 0], 'Dm': [2, 2, 1, 0], 'D7': [2, 2, 2, 3],
            'E': [4, 4, 4, 2], 'Em': [0, 4, 3, 2], 'E7': [1, 2, 0, 2],
            'F': [2, 0, 1, 0], 'Fm': [1, 0, 1, 3],
            'G': [0, 2, 3, 2], 'Gm': [0, 2, 3, 1], 'G7': [0, 2, 1, 2],
            'A': [2, 1, 0, 0], 'Am': [2, 0, 0, 0], 'A7': [0, 1, 0, 0],
            'B': [4, 3, 2, 2], 'Bm': [4, 2, 2, 2], 'B7': [2, 3, 2, 2],
            'Bb': [3, 2, 1, 1]
            // Add more as needed or smart-compute
        };

        // CHROMATIC SCALE for transposition
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // 2. SONG DATABASE (Simplified Format)
        // Each line is roughly 4 beats by default unless specified.
        // Format: Array of objects { c: 'Accord', l: 'Lyrics' }
        // For simplicity, we assume 4/4 signature and 1 line = 1 bar (4 beats) approx for this demo,
        // or we can treat each entry as a "segment" of time defined by BPM.

        const SONGS = [
            {
                title: "I'm Yours - Jason Mraz",
                bpm: 150, // fast-ish reggae feel
                chords: [
                    { c: 'C', l: "Well, you done done me in, you bet I felt it" },
                    { c: 'G', l: "I tried to be chill, but you're so hot that I melted" },
                    { c: 'Am', l: "I fell right through the cracks" },
                    { c: 'F', l: "Now I'm trying to get back" },
                    { c: 'C', l: "Before the cool done run out I'll be giving it my bestest" },
                    { c: 'G', l: "And nothing's gonna stop me but divine intervention" },
                    { c: 'Am', l: "I reckon it's again my turn" },
                    { c: 'F', l: "To win some or learn some" },
                    { c: 'C', l: "But I won't hesitate" },
                    { c: 'G', l: "No more, no more" },
                    { c: 'Am', l: "It cannot wait," },
                    { c: 'F', l: "I'm yours..." }
                ]
            },
            {
                title: "Riptide - Vance Joy",
                bpm: 100,
                chords: [
                    { c: 'Am', l: "I was scared of dentists and the dark" },
                    { c: 'G', l: "I was scared of pretty girls and starting conversations" },
                    { c: 'C', l: "Oh, all my friends are turning green" },
                    { c: 'Am', l: "You're the magician's assistant in their dream" },
                    { c: 'G', l: "Oh, oh, oh" },
                    { c: 'C', l: "And they come unstuck" },
                    { c: 'Am', l: "Lady, running down to the riptide" },
                    { c: 'G', l: "Taken away to the dark side" },
                    { c: 'C', l: "I wanna be your left hand man" },
                    { c: 'Am', l: "I love you when you're singing that song and" },
                    { c: 'G', l: "I got a lump in my throat 'cause" },
                    { c: 'C', l: "You're gonna sing the words wrong" }
                ]
            },
            {
                title: "Somewhere Over The Rainbow - IZ",
                bpm: 85,
                chords: [
                    { c: 'C', l: "Oooo, oooo" }, { c: 'Em', l: "Oooo, oooo" },
                    { c: 'F', l: "Oooo, oooo" }, { c: 'C', l: "Oooo..." },
                    { c: 'C', l: "Somewhere over the rainbow" },
                    { c: 'G', l: "Way up high" },
                    { c: 'F', l: "And the dreams that you dreamed of" },
                    { c: 'C', l: "Once in a lullaby" },
                    { c: 'C', l: "Somewhere over the rainbow" },
                    { c: 'G', l: "Bluebirds fly" },
                    { c: 'F', l: "And the dreams that you dreamed of" },
                    { c: 'C', l: "Dreams really do come true" }
                ]
            },
            {
                title: "Can't Help Falling in Love - Elvis",
                bpm: 100, // 6/8 simplified to linear flow
                chords: [
                    { c: 'C', l: "Wise" }, { c: 'G', l: "men" }, { c: 'Am', l: "say" },
                    { c: 'F', l: "only" }, { c: 'C', l: "fools" }, { c: 'G', l: "rush in" },
                    { c: 'F', l: "But" }, { c: 'G', l: "I" }, { c: 'Am', l: "can't" }, { c: 'F', l: "help" },
                    { c: 'C', l: "falling in" }, { c: 'G', l: "love" }, { c: 'C', l: "with you" }
                ]
            },
            {
                title: "Stand By Me - Ben E. King",
                bpm: 118,
                chords: [
                    { c: 'A', l: "When the night has come" },
                    { c: 'F#m', l: "And the land is dark" },
                    { c: 'D', l: "And the moon is the only" },
                    { c: 'E', l: "Light we'll see" },
                    { c: 'A', l: "No I won't be afraid, no I won't be afraid" },
                    { c: 'F#m', l: "Just as long as you stand" },
                    { c: 'D', l: "Stand by me" },
                    { c: 'A', l: "So darlin', darlin', stand by me" }
                ]
            }
            // More songs can be added here
        ];

        /**
         * ENGINE
         */

        class UkeApp {
            constructor() {
                this.currentSong = null;
                this.isPlaying = false;
                this.currentIndex = 0;
                this.intervalId = null;
                this.speedMultiplier = 1.0;
                this.transposeStep = 0;

                // Settings
                this.beatsPerSegment = 4; // Simplification: assume each array item is 1 Bar (4 beats)

                this.initUI();
                this.loadSongList();

                // Initial state
                this.loadSong(0);
            }

            initUI() {
                // Elements
                this.els = {
                    select: document.getElementById('song-select'),
                    chordDisplay: document.getElementById('current-chord-name'),
                    canvas: document.getElementById('chord-canvas'),
                    linePrev: document.getElementById('line-prev'),
                    lineCurr: document.getElementById('line-curr'),
                    lineNext: document.getElementById('line-next'),
                    btnPlay: document.getElementById('btn-play'),
                    btnReset: document.getElementById('btn-reset'),
                    speedSlider: document.getElementById('speed-slider'),
                    speedVal: document.getElementById('speed-val'),
                    progress: document.getElementById('progress-fill'),
                    timeDisplay: document.getElementById('time-display'),
                    btnUp: document.getElementById('btn-transpose-up'),
                    btnDown: document.getElementById('btn-transpose-down'),
                    transVal: document.getElementById('transpose-val'),
                    barDisplay: document.getElementById('bar-display')
                };

                // Listeners
                this.els.btnPlay.onclick = () => this.togglePlay();
                this.els.btnReset.onclick = () => this.reset();
                this.els.select.onchange = (e) => this.loadSong(parseInt(e.target.value));

                this.els.speedSlider.oninput = (e) => {
                    this.speedMultiplier = parseFloat(e.target.value);
                    this.els.speedVal.innerText = Math.round(this.speedMultiplier * 100) + "%";
                };

                this.els.btnUp.onclick = () => this.transpose(1);
                this.els.btnDown.onclick = () => this.transpose(-1);
            }

            loadSongList() {
                SONGS.forEach((song, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.innerText = song.title;
                    this.els.select.appendChild(opt);
                });
            }

            transpose(step) {
                this.transposeStep += step;
                this.els.transVal.innerText = this.transposeStep > 0 ? `+${this.transposeStep}` : this.transposeStep;
                this.updateDisplay(); // Redraw current chord
            }

            getTransposedChord(chordName) {
                if (!chordName) return "";
                // Simple regex to split Note + Suffix (e.g. "C#m" -> "C#", "m")
                const match = chordName.match(/^([A-G][#b]?)(.*)$/);
                if (!match) return chordName;

                let note = match[1];
                let suffix = match[2];

                // Normalise flats to sharps for simplicity in lookup
                const flatMap = { 'Bb': 'A#', 'Eb': 'D#', 'Ab': 'G#', 'Db': 'C#', 'Gb': 'F#' };
                if (flatMap[note]) note = flatMap[note];

                let idx = NOTES.indexOf(note);
                if (idx === -1) return chordName; // Fallback

                // Calculate new index wrapping around 12
                let newIdx = (idx + this.transposeStep) % 12;
                if (newIdx < 0) newIdx += 12;

                return NOTES[newIdx] + suffix;
            }

            loadSong(idx) {
                this.stop();
                this.currentSong = SONGS[idx];
                this.currentIndex = 0;
                this.transposeStep = 0;
                this.els.transVal.innerText = "0";
                this.updateDisplay();
            }

            togglePlay() {
                if (this.isPlaying) this.stop();
                else this.start();
            }

            start() {
                if (!this.currentSong) return;
                this.isPlaying = true;
                this.els.btnPlay.innerHTML = "‚è∏ Pause";
                this.els.btnPlay.classList.add('secondary');
                this.els.btnPlay.classList.remove('accent');

                // Logic to calculate step duration
                // BPM = Beats Per Minute. 
                // We assume each array part is 4 beats (1 bar).
                // Duration (ms) = (60000 / BPM) * 4 * (1/Speed)

                const loop = () => {
                    if (!this.isPlaying) return;

                    // Advance
                    this.currentIndex++;

                    if (this.currentIndex >= this.currentSong.chords.length) {
                        this.stop();
                        return;
                    }

                    this.updateDisplay();

                    // Schedule next check
                    const msPerBeat = 60000 / this.currentSong.bpm;
                    const msPerBar = msPerBeat * 4;
                    const realDuration = msPerBar / this.speedMultiplier;

                    this.intervalId = setTimeout(loop, realDuration);
                    this.animateProgress(realDuration);
                };

                // Start immediately
                this.updateDisplay();
                const msPerBeat = 60000 / this.currentSong.bpm;
                const msPerBar = msPerBeat * 4;
                const realDuration = msPerBar / this.speedMultiplier;

                this.animateProgress(realDuration);
                this.intervalId = setTimeout(loop, realDuration);
            }

            stop() {
                this.isPlaying = false;
                clearTimeout(this.intervalId);
                this.els.btnPlay.innerHTML = "‚ñ∂ Play";
                this.els.btnPlay.classList.remove('secondary');
                this.els.btnPlay.classList.add('accent');

                // Kill progress animation
                this.els.progress.style.transition = 'none';
                this.els.progress.style.width = '0%';
            }

            reset() {
                this.stop();
                this.currentIndex = 0;
                this.updateDisplay();
            }

            animateProgress(duration) {
                // Reset to 0 forced
                this.els.progress.style.transition = 'none';
                this.els.progress.style.width = '0%';

                // Force reflow
                void this.els.progress.offsetWidth;

                // Animate to 100%
                this.els.progress.style.transition = `width ${duration}ms linear`;
                this.els.progress.style.width = '100%';
            }

            updateDisplay() {
                if (!this.currentSong) return;

                // Get neighbors
                const prev = this.currentSong.chords[this.currentIndex - 1];
                const curr = this.currentSong.chords[this.currentIndex];
                const next = this.currentSong.chords[this.currentIndex + 1];

                // Transpose logic for display
                const tCurr = curr ? this.getTransposedChord(curr.c) : "";
                const tPrev = prev ? this.getTransposedChord(prev.c) : "";
                const tNext = next ? this.getTransposedChord(next.c) : "";

                // UI Text
                this.els.chordDisplay.innerText = tCurr || "-";

                this.els.linePrev.innerHTML = prev ? `<span class="chord-badge">${tPrev}</span> ${prev.l}` : "";
                this.els.lineCurr.innerHTML = curr ? `<span class="chord-badge">${tCurr}</span> ${curr.l}` : "Fin de la canci√≥n";
                this.els.lineNext.innerHTML = next ? `<span class="chord-badge">${tNext}</span> ${next.l}` : "";

                // Draw Diagram
                if (tCurr) this.drawChord(tCurr);
                else this.clearCanvas();

                // Info
                const percent = Math.round((this.currentIndex / this.currentSong.chords.length) * 100);
                this.els.timeDisplay.innerText = `${percent}% Completado`;
                this.els.barDisplay.innerText = `Comp√°s: ${this.currentIndex + 1}`;
            }

            /* CANVAS DRAWING UTILS */
            clearCanvas() {
                const ctx = this.els.canvas.getContext('2d');
                ctx.clearRect(0, 0, 120, 140);
            }

            drawChord(chordName) {
                const ctx = this.els.canvas.getContext('2d');
                const w = 120, h = 140;
                const padding = 20;
                const stringGap = (w - padding * 2) / 3;
                const fretGap = (h - padding * 2) / 5;

                ctx.clearRect(0, 0, w, h);
                ctx.strokeStyle = "#444";
                ctx.lineWidth = 2;
                ctx.lineCap = "round";

                // Draw Nut (Top line)
                ctx.beginPath();
                ctx.lineWidth = 4;
                ctx.moveTo(padding, padding);
                ctx.lineTo(w - padding, padding);
                ctx.stroke();
                ctx.lineWidth = 2;

                // Draw Strings (Vertical) - G C E A
                for (let i = 0; i < 4; i++) {
                    let x = padding + i * stringGap;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, h - padding);
                    ctx.stroke();
                }

                // Draw Frets (Horizontal)
                for (let i = 1; i <= 4; i++) {
                    let y = padding + i * fretGap;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(w - padding, y);
                    ctx.stroke();
                }

                // Get fingering
                // Simplified lookup. Dealing with complex names or non-db chords gracefully
                // Try to strip 7ths or minors if not found to give *something* or just look for basic root

                let fingers = CHORD_LIBRARY[chordName];

                // Smart fallback strategies if exact chord not found
                if (!fingers) {
                    // 1. Try stripping 7 (G7 -> G)
                    if (chordName.endsWith('7')) fingers = CHORD_LIBRARY[chordName.replace('7', '')];
                    // 2. Try stripping m (Cm -> C) - dangerous musically but better than blank? 
                    // actually no, minor changes finger too much.
                    // Just default to empty if not found
                }

                if (fingers) {
                    ctx.fillStyle = "#FF6B6B";
                    fingers.forEach((fret, strIdx) => {
                        if (fret > 0) {
                            let x = padding + strIdx * stringGap;
                            let y = padding + (fret - 0.5) * fretGap;

                            ctx.beginPath();
                            ctx.arc(x, y, 7, 0, Math.PI * 2);
                            ctx.fill();
                        } else {
                            // Open string indication (circle at top)
                            let x = padding + strIdx * stringGap;
                            ctx.beginPath();
                            ctx.strokeStyle = "#4ECDC4";
                            ctx.arc(x, padding - 8, 4, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    });
                }
            }
        }

        // Start
        window.onload = () => {
            const app = new UkeApp();
        };

    </script>

</body>

</html>