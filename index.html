<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UkeFlow üå∫ - Tu Entrenador de Ukulele</title>
    <style>
        :root {
            /* RASTA PALETTE ü¶Å */
            --primary: #009B4D;
            /* Green */
            --secondary: #FFD700;
            /* Gold */
            --accent: #E43831;
            /* Red */
            --dark: #111;
            --light: #fff;
            --gradient: linear-gradient(135deg, #009B4D, #FFD700, #E43831);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #fdfdfd;
            background-image: radial-gradient(#FFD700 1.5px, transparent 1.5px);
            background-size: 25px 25px;
            color: var(--dark);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-top: 10px solid;
            border-image: var(--gradient) 1;
        }

        /* HEADER */
        header {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            padding: 0.5rem;
            text-align: center;
            border-bottom: 2px solid var(--secondary);
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        header h1 {
            font-size: 1.5rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 900;
        }

        /* MAIN LAYOUT */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            margin: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 600px;
            align-self: center;
            width: calc(100% - 40px);
            border: 1px solid #f0f0f0;
        }

        /* TOP CONTROL BAR */
        .control-bar {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #eee;
            border-bottom: 1px solid #ddd;
            align-items: center;
        }

        select {
            flex: 1;
            padding: 5px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-weight: bold;
            font-size: 0.9rem;
            height: 32px;
        }

        .mini-btn {
            border: none;
            background: var(--dark);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: transform 0.1s;
        }

        .mini-btn:hover {
            background: #333;
            transform: scale(1.1);
        }

        .mini-btn.play {
            background: var(--primary);
            font-size: 0.9rem;
        }

        .mini-btn.stop {
            background: var(--accent);
        }

        /* TELEPROMPTER (LYRICS) */
        #teleprompter {
            height: 80px;
            background: #fafafa;
            border-bottom: 1px solid #eee;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .prompter-line {
            position: absolute;
            width: 100%;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            font-weight: 500;
        }

        .prompter-line.current {
            font-size: 1.3rem;
            color: #000;
            transform: translateY(0);
            font-weight: bold;
        }

        .prompter-line.past {
            font-size: 0.9rem;
            color: #ccc;
            transform: translateY(-25px);
            opacity: 0.5;
        }

        .prompter-line.future {
            font-size: 0.9rem;
            color: #ccc;
            transform: translateY(25px);
            opacity: 0.5;
        }

        /* STAGE (CHORDS) */
        #stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
        }

        #active-chord-display {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            /* Full width for side positioning */
            min-height: 200px;
            justify-content: center;
        }

        .chord-name {
            font-size: 7rem;
            font-weight: 900;
            line-height: 1;
            margin: 0;
            color: var(--dark);
        }

        /* SIDE CHORD BOXES */
        .next-chord-box,
        .prev-chord-box {
            position: absolute;
            top: 20px;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 8px 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            z-index: 20;
            width: 75px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .prev-chord-box {
            left: 10px;
            border-color: #eee;
            opacity: 0.8;
        }

        .next-chord-box {
            right: 10px;
            border-color: var(--secondary);
            border-width: 2px;
        }

        .side-chord-label {
            font-size: 0.6rem;
            color: #999;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 3px;
            display: block;
        }

        .side-chord-val {
            font-weight: 900;
            color: var(--dark);
            font-size: 1.2rem;
            display: block;
        }

        .next-chord-box .side-chord-val {
            color: var(--primary);
        }

        /* HIGHLIGHTED CHORD BADGE IN LYRICS */
        .chord-badge {
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-weight: 900;
            margin-right: 10px;
            font-size: 0.9em;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* STRUMMING */
        .strum-container {
            background: rgba(255, 215, 0, 0.2);
            border: 1px dashed var(--secondary);
            border-radius: 8px;
            padding: 5px 15px;
            margin-top: 10px;
            text-align: center;
        }

        .strum-pattern {
            font-size: 1.2rem;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .strum-meta {
            font-size: 0.8rem;
            color: #555;
        }

        .strum-help-box {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 200px;
            text-align: left;
            display: none;
        }

        /* FOOTER CONTROLS */
        .footer-controls {
            padding: 10px;
            background: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 0.8rem;
            border-top: 1px solid #e0e0e0;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Range Input */
        input[type=range] {
            height: 4px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        /* PROGRESS */
        .progress-bar {
            height: 4px;
            background: #ddd;
            width: 100%;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
        }

        button.secondary {
            background: #ccc;
            border: none;
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>üé∏ UkeFlow üáØüá≤</h1>
    </header>

    <main>
        <!-- TOP CONTROL BAR -->
        <div class="control-bar">
            <select id="song-select">
                <option value="" disabled>Cargando canciones...</option>
            </select>
            <button id="btn-reset" class="mini-btn stop" title="Reiniciar">‚èÆ</button>
            <button id="btn-play" class="mini-btn play" title="Play/Pause">‚ñ∂</button>
        </div>

        <!-- LYRICS / PROMPTER -->
        <div id="teleprompter">
            <div class="prompter-line past" id="line-prev">...</div>
            <div class="prompter-line current" id="line-curr">¬°Listo para tocar!</div>
            <div class="prompter-line future" id="line-next">Dale Play ‚ñ∂</div>
        </div>

        <!-- PROGRESS -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- MAIN STAGE -->
        <div id="stage">
            <div id="active-chord-display">
                <!-- PREV CHORD -->
                <div class="prev-chord-box" id="prev-chord-container" style="display:none;">
                    <div class="side-chord-label">Anterior</div>
                    <div class="side-chord-val" id="prev-chord-val">-</div>
                </div>

                <!-- NEXT CHORD -->
                <div class="next-chord-box" id="next-chord-container" style="display:none;">
                    <div class="side-chord-label">Siguiente</div>
                    <div class="side-chord-val" id="next-chord-val">-</div>
                </div>

                <div class="chord-name" id="current-chord-name">-</div>
                <canvas id="chord-canvas" width="120" height="140"></canvas>
            </div>

            <!-- STRUMMING -->
            <div class="strum-container">
                <div class="strum-meta" id="strum-desc">-</div>
                <div class="strum-pattern" id="strum-pattern">-</div>
                <button id="btn-strum-help" class="strum-help-btn" style="float:right;">‚ùì</button>
                <div style="clear:both;"></div>
                <div id="strum-help-box" class="strum-help-box">
                    <strong>Gu√≠a de S√≠mbolos:</strong><br>
                    ‚¨áÔ∏è = Abajo<br>
                    ‚¨ÜÔ∏è = Arriba<br>
                    üõë = Chasquido (Mute)<br>
                    „Éª = Pausa
                </div>
            </div>
        </div>

        <!-- FOOTER SETTINGS -->
        <div class="footer-controls">
            <div class="slider-group">
                <span>Tempo:</span>
                <input type="range" id="speed-slider" min="0.5" max="1.5" step="0.1" value="1.0" style="width: 80px;">
                <span id="speed-val">100%</span>
            </div>

            <div class="slider-group">
                <span>Transponer:</span>
                <button class="secondary" id="btn-transpose-down">b</button>
                <strong id="transpose-val">0</strong>
                <button class="secondary" id="btn-transpose-up">#</button>
            </div>
        </div>
    </main>

    <script>
        /**
        * DATABASE & LOGIC
        */

        // 1. CHORD DATABASE (Standard G-C-E-A tuning)
        const CHORD_LIBRARY = {
            'C': [0, 0, 0, 3], 'Cm': [0, 3, 3, 3], 'C7': [0, 0, 0, 1],
            'D': [2, 2, 2, 0], 'Dm': [2, 2, 1, 0], 'D7': [2, 2, 2, 3],
            'E': [4, 4, 4, 2], 'Em': [0, 4, 3, 2], 'E7': [1, 2, 0, 2],
            'F': [2, 0, 1, 0], 'Fm': [1, 0, 1, 3], 'F#m': [2, 1, 2, 0],
            'G': [0, 2, 3, 2], 'Gm': [0, 2, 3, 1], 'G7': [0, 2, 1, 2],
            'A': [2, 1, 0, 0], 'Am': [2, 0, 0, 0], 'A7': [0, 1, 0, 0],
            'B': [4, 3, 2, 2], 'Bm': [4, 2, 2, 2], 'B7': [2, 3, 2, 2],
            'Bb': [3, 2, 1, 1]
        };

        // CHROMATIC SCALE for transposition
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // 2. SONG DATABASE (With YouTube IDs)
        // IDs are standard YouTube Video IDs
        // 2. SONG DATABASE (With YouTube IDs)
        // IDs are standard YouTube Video IDs
        const SONGS = [
            {
                title: "I'm Yours - Jason Mraz",
                bpm: 151,
                videoId: "EkHTsc9PU2A",
                strumming: {
                    pattern: "‚¨áÔ∏è„Éª‚¨áÔ∏è‚¨ÜÔ∏è„Éª‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÜÔ∏è",
                    desc: "Island Strum (1x por acorde)"
                },
                chords: [
                    { c: 'C', l: "Well, you done done me in, you bet I felt it" },
                    { c: 'G', l: "I tried to be chill, but you're so hot that I melted" },
                    { c: 'Am', l: "I fell right through the cracks" },
                    { c: 'F', l: "Now I'm trying to get back" },
                    { c: 'C', l: "Before the cool done run out I'll be giving it my bestest" },
                    { c: 'G', l: "And nothing's gonna stop me but divine intervention" },
                    { c: 'Am', l: "I reckon it's again my turn" },
                    { c: 'F', l: "To win some or learn some" },
                    { c: 'C', l: "But I won't hesitate" },
                    { c: 'G', l: "No more, no more" },
                    { c: 'Am', l: "It cannot wait," },
                    { c: 'F', l: "I'm yours..." }
                ]
            },
            {
                title: "Riptide - Vance Joy",
                bpm: 102,
                videoId: "uJ_1HMAGb4k",
                strumming: {
                    pattern: "‚¨áÔ∏è„Éª‚¨áÔ∏è‚¨ÜÔ∏è„Éª‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÜÔ∏è",
                    desc: "Island Strum (1x por acorde)"
                },
                chords: [
                    { c: 'Am', l: "I was scared of dentists and the dark" },
                    { c: 'G', l: "I was scared of pretty girls and starting conversations" },
                    { c: 'C', l: "Oh, all my friends are turning green" },
                    { c: 'Am', l: "You're the magician's assistant in their dream" },
                    { c: 'G', l: "Oh, oh, oh" },
                    { c: 'C', l: "And they come unstuck" },
                    { c: 'Am', l: "Lady, running down to the riptide" },
                    { c: 'G', l: "Taken away to the dark side" },
                    { c: 'C', l: "I wanna be your left hand man" },
                    { c: 'Am', l: "I love you when you're singing that song and" },
                    { c: 'G', l: "I got a lump in my throat 'cause" },
                    { c: 'C', l: "You're gonna sing the words wrong" }
                ]
            },
            {
                title: "Somewhere Over The Rainbow - IZ",
                bpm: 85,
                videoId: "V1bFr2SWP1I",
                strumming: {
                    pattern: "‚¨áÔ∏è„Éª‚¨áÔ∏è‚¨ÜÔ∏è„Éª‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÜÔ∏è",
                    desc: "Island Strum (2x por acorde)"
                },
                chords: [
                    { c: 'C', l: "Oooo, oooo" }, { c: 'Em', l: "Oooo, oooo" },
                    { c: 'F', l: "Oooo, oooo" }, { c: 'C', l: "Oooo..." },
                    { c: 'C', l: "Somewhere over the rainbow" },
                    { c: 'G', l: "Way up high" },
                    { c: 'F', l: "And the dreams that you dreamed of" },
                    { c: 'C', l: "Once in a lullaby" },
                    { c: 'C', l: "Somewhere over the rainbow" },
                    { c: 'G', l: "Bluebirds fly" },
                    { c: 'F', l: "And the dreams that you dreamed of" },
                    { c: 'C', l: "Dreams really do come true" }
                ]
            },
            {
                title: "Can't Help Falling in Love - Elvis",
                bpm: 68,
                videoId: "vGJTaP6anOU",
                strumming: {
                    pattern: "‚¨áÔ∏è„Éª‚¨áÔ∏è„Éª‚¨áÔ∏è (Arpegio)",
                    desc: "Vals Lento (1x por pulso)"
                },
                chords: [
                    { c: 'C', l: "Wise" }, { c: 'G', l: "men" }, { c: 'Am', l: "say" },
                    { c: 'F', l: "only" }, { c: 'C', l: "fools" }, { c: 'G', l: "rush in" },
                    { c: 'F', l: "But" }, { c: 'G', l: "I" }, { c: 'Am', l: "can't" }, { c: 'F', l: "help" },
                    { c: 'C', l: "falling in" }, { c: 'G', l: "love" }, { c: 'C', l: "with you" }
                ]
            },
            {
                title: "Stand By Me - Ben E. King",
                bpm: 118,
                videoId: "hwZNL7QVJjE",
                strumming: {
                    pattern: "‚¨áÔ∏èüõë„Éª‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÜÔ∏è",
                    desc: "R&B Strum (muteado)"
                },
                chords: [
                    { c: 'A', l: "When the night has come" },
                    { c: 'F#m', l: "And the land is dark" },
                    { c: 'D', l: "And the moon is the only" },
                    { c: 'E', l: "Light we'll see" },
                    { c: 'A', l: "No I won't be afraid, no I won't be afraid" },
                    { c: 'F#m', l: "Just as long as you stand" },
                    { c: 'D', l: "Stand by me" },
                    { c: 'A', l: "So darlin', darlin', stand by me" }
                ]
            },
            {
                title: "Three Little Birds - Bob Marley",
                bpm: 74,
                videoId: "LanCLS_hIo4",
                strumming: {
                    pattern: "„Éª‚¨áÔ∏è„Éª‚¨áÔ∏è (Reggae)",
                    desc: "Golpe seco abajo en tiempos 2 y 4 (Contratiempo)"
                },
                chords: [
                    { c: 'C', l: "Don't worry about a thing" },
                    { c: 'F', l: "Cause every little thing" },
                    { c: 'C', l: "Gonna be alright" },
                    { c: 'C', l: "Singing' don't worry about a thing" },
                    { c: 'F', l: "Cause every little thing" },
                    { c: 'C', l: "Gonna be alright!" },
                    { c: 'C', l: "Rise up this mornin'" },
                    { c: 'G', l: "Smiled with the risin' sun" },
                    { c: 'C', l: "Three little birds" },
                    { c: 'F', l: "Pitch by my doorstep" },
                    { c: 'C', l: "Singin' sweet songs" },
                    { c: 'G', l: "Of melodies pure and true" },
                    { c: 'F', l: "Saying', this is my message to you" }
                ]
            },
            {
                title: "Don't Worry Be Happy - Bobby McFerrin",
                bpm: 66,
                videoId: "d-diB65scQU",
                strumming: {
                    pattern: "‚¨áÔ∏èüõë„Éª‚¨áÔ∏è‚¨ÜÔ∏èüõë (Swing)",
                    desc: "Relajado"
                },
                chords: [
                    { c: 'C', l: "Here's a little song I wrote" },
                    { c: 'Dm', l: "You might want to sing it note for note" },
                    { c: 'F', l: "Don't worry" },
                    { c: 'C', l: "Be happy" },
                    { c: 'C', l: "In every life we have some trouble" },
                    { c: 'Dm', l: "But when you worry you make it double" },
                    { c: 'F', l: "Don't worry" },
                    { c: 'C', l: "Be happy" },
                    { c: 'C', l: "Oooo, ooo" },
                    { c: 'Dm', l: "Ooo, ooo" },
                    { c: 'F', l: "Ooo, ooo" },
                    { c: 'C', l: "Don't worry, be happy" }
                ]
            }
        ];

        /**
        * ENGINE
        */

        /**
        * ENGINE
        */

        class UkeApp {
            constructor() {
                this.currentSong = null;
                this.isPlaying = false;
                this.currentIndex = 0;
                this.intervalId = null;
                this.speedMultiplier = 1.0;
                this.transposeStep = 0;

                this.initUI();
                this.loadSongList();
                this.loadSong(0);

                ukeAppInstance = this;
            }

            initUI() {
                // Elements
                this.els = {
                    select: document.getElementById('song-select'),
                    chordDisplay: document.getElementById('current-chord-name'),
                    canvas: document.getElementById('chord-canvas'),
                    linePrev: document.getElementById('line-prev'),
                    lineCurr: document.getElementById('line-curr'),
                    lineNext: document.getElementById('line-next'),

                    // Buttons in Control Bar
                    btnPlay: document.getElementById('btn-play'),
                    btnReset: document.getElementById('btn-reset'),

                    // Footer Controls
                    speedSlider: document.getElementById('speed-slider'),
                    speedVal: document.getElementById('speed-val'),
                    btnUp: document.getElementById('btn-transpose-up'),
                    btnDown: document.getElementById('btn-transpose-down'),
                    transVal: document.getElementById('transpose-val'),

                    // Display Areas
                    progress: document.getElementById('progress-fill'),
                    nextChordBox: document.getElementById('next-chord-container'),
                    nextChordVal: document.getElementById('next-chord-val'),
                    prevChordBox: document.getElementById('prev-chord-container'),
                    prevChordVal: document.getElementById('prev-chord-val'),
                    strumDesc: document.getElementById('strum-desc'),
                    strumPattern: document.getElementById('strum-pattern')
                };

                // Listeners
                this.els.btnPlay.onclick = () => this.togglePlay();
                this.els.btnReset.onclick = () => this.reset();
                this.els.select.onchange = (e) => this.loadSong(parseInt(e.target.value));

                this.els.speedSlider.oninput = (e) => {
                    this.speedMultiplier = parseFloat(e.target.value);
                    this.els.speedVal.innerText = Math.round(this.speedMultiplier * 100) + "%";
                };

                this.els.btnUp.onclick = () => this.transpose(1);
                this.els.btnDown.onclick = () => this.transpose(-1);

                // Help Toggle
                document.getElementById('btn-strum-help').onclick = () => {
                    const box = document.getElementById('strum-help-box');
                    box.style.display = box.style.display === 'none' || box.style.display === '' ? 'block' : 'none';
                };
            }

            loadSongList() {
                // Clear existing
                this.els.select.innerHTML = '';
                SONGS.forEach((song, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.innerText = song.title;
                    this.els.select.appendChild(opt);
                });

                // Default Select First
                this.els.select.value = 0;
            }

            transpose(step) {
                this.transposeStep += step;
                this.els.transVal.innerText = this.transposeStep > 0 ? `+${this.transposeStep}` : this.transposeStep;
                this.updateDisplay();
            }

            getTransposedChord(chordName) {
                if (!chordName) return "";
                const match = chordName.match(/^([A-G][#b]?)(.*)$/);
                if (!match) return chordName;

                let note = match[1];
                let suffix = match[2];

                const flatMap = { 'Bb': 'A#', 'Eb': 'D#', 'Ab': 'G#', 'Db': 'C#', 'Gb': 'F#' };
                if (flatMap[note]) note = flatMap[note];

                let idx = NOTES.indexOf(note);
                if (idx === -1) return chordName;

                let newIdx = (idx + this.transposeStep) % 12;
                if (newIdx < 0) newIdx += 12;
                return NOTES[newIdx] + suffix;
            }

            loadSong(idx) {
                this.stop();
                this.currentSong = SONGS[idx];
                this.currentIndex = 0;
                this.transposeStep = 0;
                this.els.transVal.innerText = "0";

                // Update Strumming
                if (this.currentSong.strumming) {
                    this.els.strumDesc.innerText = this.currentSong.strumming.desc;
                    this.els.strumPattern.innerText = this.currentSong.strumming.pattern;
                } else {
                    this.els.strumDesc.innerText = "-";
                    this.els.strumPattern.innerText = "-";
                }

                this.updateDisplay();
            }

            togglePlay() {
                if (this.isPlaying) this.stop();
                else this.start();
            }

            start() {
                if (!this.currentSong) return;
                this.startTimer();
            }

            stop() {
                this.stopTimer();
            }

            startTimer() {
                this.isPlaying = true;
                this.els.btnPlay.innerHTML = "‚è∏";
                this.els.btnPlay.classList.add('stop');
                this.els.btnPlay.classList.remove('play');

                const loop = () => {
                    if (!this.isPlaying) return;
                    this.currentIndex++;
                    if (this.currentIndex >= this.currentSong.chords.length) {
                        this.stop();
                        return;
                    }
                    this.updateDisplay();
                    this.scheduleNextBeat(loop);
                };

                this.updateDisplay();
                this.scheduleNextBeat(loop);
            }

            scheduleNextBeat(callback) {
                // Determine speed
                const msPerBeat = 60000 / this.currentSong.bpm;
                const msPerBar = msPerBeat * 4;
                const realDuration = msPerBar / this.speedMultiplier;

                if (callback) {
                    this.intervalId = setTimeout(callback, realDuration);
                }
                this.animateProgress(realDuration);
            }

            stopTimer() {
                this.isPlaying = false;
                clearTimeout(this.intervalId);
                this.els.btnPlay.innerHTML = "‚ñ∂";
                this.els.btnPlay.classList.remove('stop');
                this.els.btnPlay.classList.add('play');

                this.els.progress.style.transition = 'none';
                this.els.progress.style.width = '0%';
            }

            reset() {
                this.stop();
                this.currentIndex = 0;
                this.updateDisplay();
            }

            animateProgress(duration) {
                this.els.progress.style.transition = 'none';
                this.els.progress.style.width = '0%';
                void this.els.progress.offsetWidth; // force reflow
                this.els.progress.style.transition = `width ${duration}ms linear`;
                this.els.progress.style.width = '100%';
            }

            updateDisplay() {
                if (!this.currentSong) return;
                const prev = this.currentSong.chords[this.currentIndex - 1];
                const curr = this.currentSong.chords[this.currentIndex];
                const next = this.currentSong.chords[this.currentIndex + 1];

                const tCurr = curr ? this.getTransposedChord(curr.c) : "";
                const tPrev = prev ? this.getTransposedChord(prev.c) : "";
                const tNext = next ? this.getTransposedChord(next.c) : "";

                this.els.chordDisplay.innerText = tCurr || "-";

                // Triple Chord Flow (Always show containers for symmetry)
                this.els.prevChordBox.style.display = "block";
                this.els.prevChordVal.innerText = tPrev || "-";
                this.els.prevChordBox.style.opacity = tPrev ? "1" : "0.3";

                this.els.nextChordBox.style.display = "block";
                this.els.nextChordVal.innerText = tNext || "-";
                this.els.nextChordBox.style.opacity = tNext ? "1" : "0.3";

                this.els.linePrev.innerHTML = prev ? `<span class="chord-badge">${tPrev}</span> ${prev.l}` : "";
                this.els.lineCurr.innerHTML = curr ? `<span class="chord-badge">${tCurr}</span> ${curr.l}` : "Fin de la canci√≥n";
                this.els.lineNext.innerHTML = next ? `<span class="chord-badge">${tNext}</span> ${next.l}` : "";

                if (tCurr) this.drawChord(tCurr);
                else this.clearCanvas();

                // Removed footer status updates
            }

            /* CANVAS DRAWING UTILS (Same as before) */
            clearCanvas() {
                const ctx = this.els.canvas.getContext('2d');
                ctx.clearRect(0, 0, 120, 140);
            }

            drawChord(chordName) {
                const ctx = this.els.canvas.getContext('2d');
                const w = 120, h = 140;
                const padding = 20;
                const stringGap = (w - padding * 2) / 3;
                const fretGap = (h - padding * 2) / 5;

                ctx.clearRect(0, 0, w, h);
                ctx.strokeStyle = "#444";
                ctx.lineWidth = 2;
                ctx.lineCap = "round";

                ctx.beginPath();
                ctx.lineWidth = 4;
                ctx.moveTo(padding, padding);
                ctx.lineTo(w - padding, padding);
                ctx.stroke();
                ctx.lineWidth = 2;

                for (let i = 0; i < 4; i++) {
                    let x = padding + i * stringGap;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, h - padding);
                    ctx.stroke();
                }

                for (let i = 1; i <= 4; i++) {
                    let y = padding + i * fretGap;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(w - padding, y);
                    ctx.stroke();
                }

                let fingers = CHORD_LIBRARY[chordName];
                if (!fingers) {
                    if (chordName.endsWith('7')) fingers = CHORD_LIBRARY[chordName.replace('7', '')];
                }

                if (fingers) {
                    ctx.fillStyle = "#009B4D"; // Green Fingers
                    fingers.forEach((fret, strIdx) => {
                        if (fret > 0) {
                            let x = padding + strIdx * stringGap;
                            let y = padding + (fret - 0.5) * fretGap;
                            ctx.beginPath();
                            ctx.arc(x, y, 7, 0, Math.PI * 2);
                            ctx.fill();
                        } else {
                            let x = padding + strIdx * stringGap;
                            ctx.beginPath();
                            ctx.strokeStyle = "#E43831"; // Red Open Strings
                            ctx.lineWidth = 2;
                            ctx.arc(x, padding - 8, 4, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    });
                }
            }
        }

        // Start
        window.onload = () => {
            if (!window.ukeAppInstance) {
                window.ukeAppInstance = new UkeApp();
            }
        };
    </script>

</body>

</html>